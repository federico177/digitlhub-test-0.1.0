# SPDX-FileCopyrightText: Â© 2025 DSLab - Fondazione Bruno Kessler
#
# SPDX-License-Identifier: AGPL-3.0-or-later

{{ range $test := .Values.platformTests }}
apiVersion: batch/v1
kind: Job
metadata:
  name: "{{ include "digitalhub.fullname" $ }}-python-test-{{ $test }}"
  labels:
    {{- include "digitalhub.labels" $ | nindent 4 }}
  annotations:
    "helm.sh/hook": test
spec:
  template:
    spec:
      containers:
        - name: python
          image: "ghcr.io/scc-digitalhub/digitalhub-tests:0.15.1"
          args:
            - "{{ $test }}"
          env:
            - name: OAUTHLIB_INSECURE_TRANSPORT
              value: "True"
            {{- if $.Values.core.authentication.openId.enabled }}
            - name: "CORE_CLIENT_ID"
              {{- if and $.Values.core.coreAuthCreds.existingSecret.secretName $.Values.core.coreAuthCreds.existingSecret.clientIdKey }}
              valueFrom:
                secretKeyRef:
                  name: {{ $.Values.core.coreAuthCreds.existingSecret.secretName }}
                  key: {{ $.Values.core.coreAuthCreds.existingSecret.clientIdKey }}
              {{- else }}
              valueFrom:
                secretKeyRef:
                  name: "core-auth-creds"
                  key: "clientId"
              {{- end }}
            - name: "CORE_CLIENT_SECRET"
              {{- if and $.Values.core.coreAuthCreds.existingSecret.secretName $.Values.core.coreAuthCreds.existingSecret.clientSecretKey }}
              valueFrom:
                secretKeyRef:
                  name: {{ $.Values.core.coreAuthCreds.existingSecret.secretName }}
                  key: {{ $.Values.core.coreAuthCreds.existingSecret.clientSecretKey }}
              {{- else }}
              valueFrom:
                secretKeyRef:
                  name: "core-auth-creds"
                  key: "clientSecret"
              {{- end }}
            - name: "DHCORE_ENDPOINT"
              value: http://{{ $.Release.Name }}-core:{{ $.Values.core.service.port }}
            - name: "DHCORE_ISSUER"
              value: http://{{ $.Release.Name }}-core:{{ $.Values.core.service.port }}
            {{- end }}
            {{- if $.Values.core.authentication.basic.enabled }}
            - name: "DHCORE_USER"
              value: {{ $.Values.core.authentication.basic.username }}
            - name: "DHCORE_PASSWORD"
              value: {{ $.Values.core.authentication.basic.password }}
            {{- end }}
          envFrom:
          - configMapRef:
              name: digitalhub-common-env
          securityContext:
            allowPrivilegeEscalation: false
            runAsNonRoot: true
            readOnlyRootFilesystem: false
            runAsUser: 8877
            capabilities:
              drop:
                - ALL
            seccompProfile:
              type: RuntimeDefault
      securityContext:
        runAsNonRoot: true
        runAsUser: 8877
        fsGroup: 999
        runAsGroup: 999
        seccompProfile:
          type: RuntimeDefault
      restartPolicy: Never
  backoffLimit: 0
---
{{ end }}