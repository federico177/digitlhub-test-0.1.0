---
# Source: digitalhub/templates/core-object-template.yaml
# SPDX-FileCopyrightText: Â© 2025 DSLab - Fondazione Bruno Kessler
#
# SPDX-License-Identifier: AGPL-3.0-or-later


apiVersion: templates.kluctl.io/v1alpha1
kind: ObjectTemplate
metadata:
  name: digitalhub-common-creds-transformer
spec:
  serviceAccountName: secret-transformer
  prune: true
  matrix:
    - name: postgressecret
      object:
        ref:
          apiVersion: v1
          kind: Secret
          name: digitalhub-owner-user.database-postgres-cluster.credentials.postgresql.acid.zalan.do
    - name: s3secret
      object:
        ref:
          apiVersion: v1
          kind: Secret
          name: platform-s3-creds
    - name: coresecret
      object:
        ref:
          apiVersion: v1
          kind: Secret
          name: core-auth-creds
  templates:
  - object:
      apiVersion: v1
      kind: Secret
      metadata:
        name: "digitalhub-common-creds"
      stringData:
        DB_USERNAME: "{{ matrix.postgressecret.data.username | b64decode }}"
        DB_PASSWORD: "{{ matrix.postgressecret.data.password | b64decode }}"
        AWS_ACCESS_KEY_ID: "{{ matrix.s3secret.data.accessKey | b64decode }}"
        AWS_SECRET_ACCESS_KEY: "{{ matrix.s3secret.data.secretKey | b64decode }}"
        DB_URL: "postgresql://{{ matrix.postgressecret.data.username | b64decode }}:{{ matrix.postgressecret.data.password | b64decode }}@database-postgres-cluster:5432/digitalhub"
        DHCORE_CLIENT_ID: "{{ matrix.coresecret.data.clientId | b64decode }}"
        DHCORE_USER: coreuser
        DHCORE_PASSWORD: corepwd
